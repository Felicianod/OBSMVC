@model OBSMVC.Models.QuestionMDViewModel
@{  ViewBag.Title = "Edit Question"; }

<script type="text/javascript">
    //$(function () {
    //    $("input:text.editDate").datepicker({
    //        changeMonth: true,
    //        changeYear: true,
    //        dateFormat: 'M dd, yy'
    //    });
    //});


    $(function () {
        $("#obs_question_eff_st_dt").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'M dd, yy'
        });
    });
    $(function () {
        $("#obs_question_eff_end_dt").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'M dd, yy'
        });
    });

</script>

<!-- Form Edit State Change Validation -->
<script>
    $(document).ready(function () {
        var isChanged = false;
        $('input, select, textarea').change(function () {
            //$("input[type='submit']").removeAttr("disabled");
            if ($('#btnAdd').text() != "Add Question") {
                $('#btnAdd').button('reset');
            }
            $("#btnSave").removeAttr('disabled');
            isChanged = true;
        });
        $(window).bind('beforeunload', function () {
            if (isChanged) {
                return 'There are unsaved changed. Do you want to discard Changes and Exit?';
            } else {
                return undefined;
            }
        });
        $("#btnSave").click(function () {
            isChanged = false;
            $(this).button('loading');
        });
        //$(".btn").click(function () {
        //    isChanged = false;
        //    $(this).button('loading');
        //});
    });
</script>

<script>
    //Make all inner panel the same hight as the tallest panel (For proportional display)
    $(document).ready(function () {
        var heightTallest = Math.max.apply(null, $(".panel-info").map(function () {
            return $(this).outerHeight();
        }).get());        
        $('.panel-info').css({ height: heightTallest + 'px' });
        heightTallest = 50;
        $('#partialPanel').css({ height: heightTallest + 'px' });
    });
</script>

@*<script>
        $(function () {
            setTimeout(function () {
                $("#ConfMsg").hide();
            }, 3000);
        });
    </script>*@

<div class="well well-sm" style="text-align:center"><h3>Edit Question Information</h3></div>
@Html.ValidationSummary(true, "", new { @class = "text-danger" })

   <form class="form-horizontal" role="form" method="post">
        <div class="row">
            <!-- Display A single edit form column -->
            <div class="col-md-6 personal-info">

                @Html.AntiForgeryToken()

                <div class="form-group row">
                    <input type="hidden" value="@Model.q.obs_question_id" name="q.obs_question_id" id="q.obs_question_id">
                </div>
                <div class="form-group row">
                    @Html.LabelFor(model => model.q.obs_question_full_text, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="input-group col-md-6">
                        @*<input type="text" value="@Model.q.obs_question_full_text" class="form-control" name="obs_question_full_text" id="obs_question_full_text" />*@
                        @Html.EditorFor(model => model.q.obs_question_full_text, new { htmlAttributes = new { @class = "form-control ", @cols = 80, @rows = 3 } })
                        @Html.ValidationMessageFor(model => model.q.obs_question_full_text, "", new { @class = "text-danger" })
                    </div>
                </div>
                @*<div class="form-group row">
                    @Html.LabelFor(model => model.q.obs_question_short_text, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="input-group col-md-6">
                        @Html.EditorFor(model => model.q.obs_question_short_text, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.q.obs_question_short_text, "", new { @class = "text-danger" })
                    </div>
                </div>*@
                <div class="form-group row">
                    @Html.LabelFor(model => model.q.obs_question_desc, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="input-group col-md-6">
                        @Html.EditorFor(model => model.q.obs_question_desc, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.q.obs_question_desc, "", new { @class = "text-danger" })
                    </div>
                </div>
                <div class="form-group row">
                    @Html.LabelFor(model => model.q.obs_question_eff_st_dt, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="input-group col-md-6">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                        @*@Html.EditorFor(model => model.q.obs_question_eff_st_dt, new { htmlAttributes = new { @class = "form-control", id = "q.obs_question_eff_st_dt", name = "q.obs_question_eff_st_dt" } })*@
                        <input type='text' class="form-control" id='obs_question_eff_st_dt' name="q.obs_question_eff_st_dt" value="@Model.q.obs_question_eff_st_dt" />
                        @Html.ValidationMessageFor(model => model.q.obs_question_eff_st_dt, "", new { @class = "text-danger" })
                    </div>
                </div>
                <div class="form-group row">
                    @Html.LabelFor(model => model.q.obs_question_eff_end_dt, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="input-group col-md-6">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                        <input type='text' class="form-control" id='obs_question_eff_end_dt' name="q.obs_question_eff_end_dt" value="@Model.q.obs_question_eff_end_dt" />
                        @*@Html.EditorFor(model => model.q.obs_question_eff_end_dt, new { htmlAttributes = new { @class = "form-control", id = "q.obs_question_eff_end_dt", name = "q.obs_question_eff_end_dt" } })*@
                        @Html.ValidationMessageFor(model => model.q.obs_question_eff_end_dt, "", new { @class = "text-danger" })
                    </div>
                </div>
                <br />
            </div>
            @if (Model.q.obs_question_eff_end_dt > DateTime.Today)
            {
                <div class="col-md-6 personal-info">
                    <div class="panel panel-info " id="partialPanel">
                        <div class="panel-heading">
                            <b>Default Answer Type</b>
                        </div>
                        <div class="panel-body" id="answerSection">
                            @*@Html.Partial("_listAnswerTypes")*@
                            @*@{ Html.RenderAction("displayAnswerSection", new { question_id = Model.q.obs_question_id});}*@
                            <div style="text-align: center">
                                <br /><br /><br />
                                <input type="button" id="refresh" value="Review-Change Answer Type" onclick="@("window.location.href='" + @Url.Action("displayAnswerSection", "Question", new { id = Model.q.obs_question_id }) + "'");" />
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="col-md-6 personal-info">
                    <div class="panel panel-info " id="partialPanel">
                        <div class="panel-heading">
                            <b>Default Answer Type</b>
                        </div>
                        <div class="panel-body" id="answerSection">
                            <div style="text-align: center">
                                <br /><br /><br />
                                <span style="color:red">WARNING! <br/>This question is no longer active.<br/>The Answer type Information cannot be edited.</span>
                            </div>
                        </div>

                    </div>
                </div>
            }
        </div>
       @if (Model.q.obs_question_eff_end_dt > DateTime.Today)
       {
        @* ---------- NEW ROW WITH TEST CODE--------------*@
        <div class="row">
            <div class="col-md-12 personal-info">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <table style="width:100%">
                            <tr>
                                <td>
                                    <b>Question Metadata Maintenance</b>
                                </td>
                                <td style="text-align:right">
                                    <button type="button" class="btnAdd" data-toggle="modal" data-target="#NewMDTag"><img src="~/Images/Button-Add-icon.png" height="25" />Add New Metedata Tag</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="panel-body">
                        <input type="hidden" id="qAssignedMD" name="qAssignedMD" />
                        @foreach (int item in Model.preMetaDataIds)
                        {
                            <input type="hidden" id="origTags" name="origTags" value="@item" />
                        }
                        <table style="width:100%">
                            <tr>
                                <td style="width:45%; border:double; text-align:center; vertical-align:top">
                                    <b>ASSIGNED QUESTION METADATA TAGS</b>   <br />
                                    <select id="sbOne" multiple="multiple" size="10" style="width:95%">
                                        @foreach (var item in Model.qAssignedMD)
                                        {
                                            <option value="@item.obs_quest_md_id">@item.obs_quest_md_value [@item.obs_quest_md_cat]</option>
                                        }
                                    </select>
                                    <br /><br />
                                </td>
                                <td style="width:10%; text-align:center; font-weight:bold; color:blue ">
                                    <input type="button" id="left" style="width:50px" value="<" /> <br /><br />
                                    <input type="button" id="right" style="width:50px" value=">" /> <br /><br />
                                    <input type="button" id="leftall" style="width:50px" value="<<" /> <br /><br />
                                    <input type="button" id="rightall" style="width:50px" value=">>" /> <br />
                                </td>
                                <td style="width:45%; border:double; text-align:center; vertical-align:top">
                                    <b>AVAILABLE METADATA TAGS</b>   <br />
                                    <select id="sbTwo" multiple="multiple" size="10" style="width:95%">
                                        @foreach (var item in Model.qUnassignedMD)
                                        {
                                            <option value="@item.obs_quest_md_id">@item.obs_quest_md_value [@item.obs_quest_md_cat]</option>
                                        }
                                    </select>
                                    <br /><br />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        @* ---------- END OF NEW ROW WITH TEST CODE--------------*@

        @* - - - - - - - - - OLD CHECK BOX METADATA VIEW FORMAT - - - - - - - - *@
        @*<div class="row">
            <div class="col-md-6 personal-info">
                <div class="panel panel-info">
                    <div class="panel-heading">Assigned Question Metadata</div>
                    <div class="panel-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                @foreach (int item in Model.preMetaDataIds)
                                {
                                    <input type="hidden" id="origTags" name="origTags" value="@item" />
                                }
                                <table class="table table-condensed table-hover">
                                    <tr>
                                        <th></th>
                                        <th>Value</th>
                                        <th>Category</th>
                                    </tr>
                                    @foreach (var item in Model.qAssignedMD)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" id="qAssignedMD" name="qAssignedMD" checked="checked" value="@item.obs_quest_md_id" />
                                            </td>
                                            <td>
                                                <input type="hidden" id="qAssignedMD" name="qAssignedMD" value="@item.obs_quest_md_id" />
                                                @item.obs_quest_md_value
                                            </td>
                                            <td>
                                                @item.obs_quest_md_cat
                                            </td>
                                        </tr>
                                    }
                                </table>
                                <br />
                                //@{Html.RenderAction("qMetaDataList", new { postId = p.Id });}
                                //@{Html.RenderAction("qMetaDataList");}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 personal-info">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <table style="width:100%">
                            <tr>
                                <td>
                                    Available Metadata Tags
                                </td>
                                <td style="text-align:right">
                                    <button type="button" class="btn btn-info btn-lg" style="font-size:small" data-toggle="modal" data-target="#NewMDTag">Add New Metedata Tag</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="panel-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <table class="table table-condensed table-hover">
                                    <tr>
                                        <th></th>
                                        <th>Value</th>
                                        <th>Category</th>
                                    </tr>
                                    @foreach (var item in Model.qUnassignedMD)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" value="@item.obs_quest_md_id" id="qAssignedMD" name="qAssignedMD">
                                            </td>
                                            <td>
                                                @item.obs_quest_md_value
                                            </td>
                                            <td>
                                                @item.obs_quest_md_cat
                                            </td>
                                        </tr>
                                    }
                                </table>
                                <br />
                                //@{Html.RenderAction("qMetaDataList", new { postId = p.Id });}
                                //@{Html.RenderAction("qMetaDataList");}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>*@
        
           <div class="row">
            <div class="col-md-12 ">
                <div class="form-group row">
                    <div class="col-md-offset-2 col-md-6">
                        <button type="submit" class="btn btn-primary" disabled="disabled" id="btnSave" onclick="compileTagList();" >Save Changes</button>
                        <span></span>
                        <input type="reset" class="btn btn-default" value="Cancel">
                    </div>
                </div>
                @if (ViewBag.ConfMsg != null)
                {
                    <div id="ConfMsg" style="text-align:center; font-weight: bold; color:green">
                        @ViewBag.ConfMsg
                    </div>
                    <script>
                        $(function () {
                            setTimeout(function () {
                                $("#ConfMsg").hide();
                            }, 3000);
                        });
                    </script>
                }

            </div>
        </div>
       }
   </form>
@* ------------ END OF THE FORM ---------- *@

@* ---------------------- POP UP "Add New Metadata Tag" FORM ------------------------ *@
<!-- Modal -->
<div class="modal" id="NewMDTag" role="dialog">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Metadata Tag</h4>
            </div>
            <div class="modal-body">
                @{var actionURL = "/QuestionMetadata/Create/" + Model.q.obs_question_id; }
                <form action="@actionURL" method="post">
                    @Html.AntiForgeryToken()
                    <div class="form-horizontal">
                        <hr />

                        <div class="form-group">
                            <label class="control-label col-md-2" for="obs_quest_md_value">Metadata Value</label>
                            <div class="col-md-10">
                                <input class="form-control text-box single-line" id="obs_quest_md_value" name="obs_quest_md_value" type="text" value="" />
                                <span class="field-validation-valid text-danger" data-valmsg-for="obs_quest_md_value" data-valmsg-replace="true"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2" for="obs_quest_md_cat">Metadata Category</label>
                            <div class="col-md-10">
                                <input class="form-control text-box single-line" id="obs_quest_md_cat" name="obs_quest_md_cat" type="text" value="" />
                                <span class="field-validation-valid text-danger" data-valmsg-for="obs_quest_md_cat" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        @*<input type="hidden" name="qId" id="qId" value="0" />*@
                    </div>
                    <div class="modal-footer">
                        <input type="hidden" value="@Model.q.obs_question_id" id="qId" name="qId" />
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Tag</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@* ---------------------- END OF "Add New Metadata Tag" FORM ------------------------ *@






    @*<div class="row">
           @if (ViewBag.ConfMsg != null)
           {
              <div id="ConfMsg" style="text-align:center; font-weight: bold; color:green">
                  Employee Information Saved Successfully.
              </div>
           }
        </div>*@
    <div class="row">
        @Html.ActionLink("Back to List", "Index")
    </div>


@*SCRIP to move Question Metadata Tags across pannels*@
<script>
    $(function () {
        function moveItems(origin, dest) {
            $(origin).find(':selected').appendTo(dest);
        }

        function moveAllItems(origin, dest) {
            $(origin).children().appendTo(dest);
        }

        $('#left').click(function () {
            moveItems('#sbTwo', '#sbOne');
        });

        $('#right').on('click', function () {
            moveItems('#sbOne', '#sbTwo');
        });

        $('#leftall').on('click', function () {
            moveAllItems('#sbTwo', '#sbOne');
        });

        $('#rightall').on('click', function () {
            moveAllItems('#sbOne', '#sbTwo');
        });
    });
</script>
<script>
    function compileTagList() {
        var tagList = getTagListValues();
        document.getElementById("qAssignedMD").setAttribute("Value", tagList);
        //var hiddenFld = document.getElementById("qAssignedMD").value;
        //alert("Result is: " + hiddenFld);
        //return true;
    };

    function getTagListValues() {
        var tagList = document.getElementById("sbOne");
        var listResult = "";
        var i;
        for (i = 0; i < tagList.length; i++) {
            listResult = listResult + tagList.options[i].value;
            if (i != tagList.length - 1)
            { listResult = listResult + ","; }
        }
        //alert(tagList);
        return listResult;
    };
</script>